<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jason Hsiao">
<meta name="dcterms.date" content="2024-02-13">

<title>Walkthrough of Predicting IgG Titers Using Tidymodels Machine Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CMI-PB_Prediction_Walkthrough_files/libs/clipboard/clipboard.min.js"></script>
<script src="CMI-PB_Prediction_Walkthrough_files/libs/quarto-html/quarto.js"></script>
<script src="CMI-PB_Prediction_Walkthrough_files/libs/quarto-html/popper.min.js"></script>
<script src="CMI-PB_Prediction_Walkthrough_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CMI-PB_Prediction_Walkthrough_files/libs/quarto-html/anchor.min.js"></script>
<link href="CMI-PB_Prediction_Walkthrough_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CMI-PB_Prediction_Walkthrough_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CMI-PB_Prediction_Walkthrough_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CMI-PB_Prediction_Walkthrough_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CMI-PB_Prediction_Walkthrough_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Walkthrough of Predicting IgG Titers Using Tidymodels Machine Learning</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jason Hsiao </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 13, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><strong><em>RECOMMENDED</em></strong>: Going through the walkthrough by viewing the online version of this document is recommended, and available here: https://jhsiao12.github.io/CMI-PB_Walkthrough/. The online version allows you to view the code in a more viewable format, and also click the hyperlinks throughout this walkthrough. Please also download the Quarto file from the following repository to modify and run the code locally: https://github.com/jhsiao12/CMI-PB_Walkthrough/.</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This document is a step-by-step walkthrough that demonstrates how to build a prediction model using data from Computational Models of Immunity - Pertussis Boost <a href="https://www.cmi-pb.org/">(CMI-PB) database</a>. For this walkthrough, we will use raw data from the CMI-PB predictional challenge database to predict IgG titers at day 14 post-vaccination. More information about the data can be found on the CMI-PB website.</p>
<p>We will be predicting IgG titers using a basic ordinary least squares (OLS) regression model. As with any machine learning model, we will need to have a prediction dataset and a training dataset. The prediction dataset will contain the data we want to predict, and the training dataset will contain the data we will use to train the model.</p>
<p>We will start by pre-processing the data for modeling, learn how to specify and train the model, then perform a prediction of subject IgG titers at day 14 post-vaccination.</p>
</section>
<section id="loading-packages" class="level2">
<h2 class="anchored" data-anchor-id="loading-packages">Loading Packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)       <span class="co"># for importing data</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)     <span class="co"># for visualizing data</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)       <span class="co"># for data manipulation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load Data</h2>
<p>Let’s import our antibody titer (ab_titer) data from the online CMI-PB database. We will need the following files:</p>
<ol type="1">
<li><p>Prediction data: <code>2022BD_plasma_ab_titer.tsv</code>, <code>2022BD_subject.tsv</code>, <code>2022BD_specimen.tsv</code></p></li>
<li><p>Training data: <code>2021LD_plasma_ab_titer.tsv</code>, <code>2021LD_subject.tsv</code>, <code>2021LD_specimen.tsv</code></p></li>
</ol>
<p>The subject and specimen tables contain metadata about the subjects and specimens, which will be helpful in our predictions. The plasma_ab_titer table contains the antibody titer data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the url path for training files download</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>training_url_path <span class="ot">&lt;-</span> <span class="st">"https://www.cmi-pb.org/downloads/cmipb_challenge_datasets/current/2nd_challenge/raw_datasets/training_data/"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the training datasets</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>training_ab_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(training_url_path, <span class="st">"2021LD_plasma_ab_titer.tsv"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>training_ab <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(training_ab_file)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>training_subject_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(training_url_path, <span class="st">"2021LD_subject.tsv"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>training_subject <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(training_subject_file)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>training_specimen_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(training_url_path, <span class="st">"2021LD_specimen.tsv"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>training_specimen <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(training_specimen_file)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the same for prediction datasets</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the url path for prediction files download (different from training files path)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>prediction_url_path <span class="ot">&lt;-</span> <span class="st">"https://www.cmi-pb.org/downloads/cmipb_challenge_datasets/current/2nd_challenge/raw_datasets/prediction_data/"</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the prediction datasets</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>prediction_ab_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(prediction_url_path, <span class="st">"2022BD_plasma_ab_titer.tsv"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>prediction_ab <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(prediction_ab_file)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>prediction_subject_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(prediction_url_path, <span class="st">"2022BD_subject.tsv"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>prediction_subject <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(prediction_subject_file)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>prediction_specimen_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(prediction_url_path, <span class="st">"2022BD_specimen.tsv"</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>prediction_specimen <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(prediction_specimen_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong><em>Note</em></strong>: Since CMI-PB releases new data every year, the link used below may not be current. If this occurs, you will have to download the raw datasets from either the following <a href="https://github.com/jhsiao12/CMI-PB_Walkthrough/">repository</a> or the CMI-PB website, under <a href="https://www.cmi-pb.org/blog/prediction-challenge-overview/#Data%20and%20resources">Data and Resources tab</a>.</p>
<p>If you still have trouble locating the files, there is a helpful <a href="https://discuss.cmi-pb.org/">Solutions Center</a> where you may post questions and get help from the CMI-PB community.</p>
</section>
<section id="data-pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="data-pre-processing">Data Pre-Processing</h2>
<section id="join-tables" class="level3">
<h3 class="anchored" data-anchor-id="join-tables">Join tables</h3>
<p>We want to have a master table for each of the training and prediction datasets such that each one contains antibody titer and associated metadata.</p>
<p>Firstly, <code>subject_id</code> corresponds to the unique identifier for each volunteer, from which specimens (samples) are collected at different time points, designated by <code>specimen_id</code>. To obtain a master metadata table for each of the training and prediction datasets (<code>subject_specimen</code>), we will join the subject and specimen tables by <code>subject_id</code>.</p>
<p>Then, to attach metadata to the training and prediction data, we will join the <code>subject_specimen</code> and abtiter tables by <code>specimen_id</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join the subject and specimen tables by subject_id (common denominator for both tables) in the training dataset</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>training_meta <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(training_subject, training_specimen, <span class="at">by =</span> <span class="st">"subject_id"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the same for prediction data</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>prediction_meta <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(prediction_subject, prediction_specimen, <span class="at">by =</span> <span class="st">"subject_id"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Join the training antibody titer table to its metadata by specimen_id (common denominator for both tables)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(training_ab, training_meta, <span class="at">by =</span> <span class="st">"specimen_id"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the same for prediction</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(prediction_ab, prediction_meta, <span class="at">by =</span> <span class="st">"specimen_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inspect-the-data" class="level3">
<h3 class="anchored" data-anchor-id="inspect-the-data">Inspect the Data</h3>
<p>Now that we have our master tables for the training and prediction datasets, we can inspect the data to see what we are working with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect each dataset</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 20
  specimen_id isotype is_antigen_specific antigen    MFI MFI_normalised unit 
        &lt;dbl&gt; &lt;chr&gt;   &lt;lgl&gt;               &lt;chr&gt;    &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;
1         468 IgG     FALSE               PRN       700.          0.111 MFI  
2         468 IgG     FALSE               DT       8924.          0.706 MFI  
3         468 IgG     FALSE               FHA      2362.         10.6   MFI  
4         468 IgG     FALSE               FIM2/3    756.          1.42  MFI  
5         468 IgG     FALSE               TT      14728.          1.11  MFI  
6         468 IgG     FALSE               PT        113.          1     MFI  
# ℹ 13 more variables: lower_limit_of_detection &lt;dbl&gt;, subject_id &lt;dbl&gt;,
#   infancy_vac &lt;chr&gt;, biological_sex &lt;chr&gt;, ethnicity &lt;chr&gt;, race &lt;chr&gt;,
#   year_of_birth &lt;date&gt;, date_of_boost &lt;date&gt;, dataset &lt;chr&gt;,
#   actual_day_relative_to_boost &lt;dbl&gt;, planned_day_relative_to_boost &lt;dbl&gt;,
#   specimen_type &lt;chr&gt;, visit &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(prediction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 20
  specimen_id isotype is_antigen_specific antigen    MFI MFI_normalised unit 
        &lt;dbl&gt; &lt;chr&gt;   &lt;lgl&gt;               &lt;chr&gt;    &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;
1         740 IgG     TRUE                DT        232.           2.56 MFI  
2         740 IgG     TRUE                FHA      6038.           1.11 MFI  
3         740 IgG     TRUE                FIM2/3   8426.           2.98 MFI  
4         740 IgG     TRUE                OVA      8423.           2.78 MFI  
5         740 IgG     TRUE                PRN     20267.           1.63 MFI  
6         740 IgG     TRUE                PT      20982.           1.36 MFI  
# ℹ 13 more variables: lower_limit_of_detection &lt;dbl&gt;, subject_id &lt;dbl&gt;,
#   infancy_vac &lt;chr&gt;, biological_sex &lt;chr&gt;, ethnicity &lt;chr&gt;, race &lt;chr&gt;,
#   year_of_birth &lt;date&gt;, date_of_boost &lt;date&gt;, dataset &lt;chr&gt;,
#   actual_day_relative_to_boost &lt;dbl&gt;, planned_day_relative_to_boost &lt;dbl&gt;,
#   specimen_type &lt;chr&gt;, visit &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Notice that we have IgG against other <code>antigen</code>s such as <code>PRN</code>, <code>DT</code>, etc… We are only looking at IgG <code>PT</code>, so let’s filter the data to only include <code>isotype = IgG</code> and <code>antigen = PT</code>.</p>
</section>
<section id="filtering-for-igg-pt-data" class="level3">
<h3 class="anchored" data-anchor-id="filtering-for-igg-pt-data">Filtering for IgG PT Data</h3>
<p>We want only IgG PT, so we will reassign the <code>training</code> and <code>prediction</code> objects to only include specimens that are IgG PT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the data to only include IgG PT</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span> <span class="fu">filter</span>(antigen <span class="sc">==</span> <span class="st">"PT"</span>, isotype <span class="sc">==</span> <span class="st">"IgG"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> prediction <span class="sc">%&gt;%</span> <span class="fu">filter</span>(antigen <span class="sc">==</span> <span class="st">"PT"</span>, isotype <span class="sc">==</span> <span class="st">"IgG"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s plot the data of <code>MFI_normalised</code> over time (<code>actual_day_relative_to_boost</code>) and see what we have:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(training,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(actual_day_relative_to_boost, MFI_normalised,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> infancy_vac,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">group =</span> subject_id)) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">0</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">14</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CMI-PB_Prediction_Walkthrough_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>While the overall trend is more like a curve, we can see that from day 0 to day 14, the data is more or less linear. Given that we are predicting the antibody titers at day 14, a linear model is a good starting point.</p>
<p>We can go one-step further and make our model more complex. If we look at the plot above, we can see that <code>infancy_vac</code> status has an influence on baseline IgG_PT values (y-intercept), and also the slope from day 0 to day 14 for each subject (each line). We can account for this later when we specify our model by adding <code>infancy_vac</code> as a predictor in the model.</p>
<p><strong><em>OPTIONAL</em></strong>: try and color the lines by other variables such as <code>biological_sex</code> to see if there are any differences in the data there! You may also try use these other variables as predictors in the model.</p>
<p>Now, let’s firstly split the training data into a training set and a validation set.</p>
</section>
</section>
<section id="split-the-training-data" class="level2">
<h2 class="anchored" data-anchor-id="split-the-training-data">Split the Training Data</h2>
<p>In machine learning, it is important to split the training data into a training set and a validation set. The training set will be used to train the model, and the validation set will be used to evaluate the model’s performance. Once we have the model, we can use it to predict the antibody titers in the prediction dataset by applying the model to the prediction dataset.</p>
<p>You are welcome to look for other resources to help you understand this concept, since it is a fundamental concept in machine learning. Here is a helpful <a href="https://medium.com/@nahmed3536/the-motivation-for-train-test-split-2b1837f596c3#:~:text=In%20Machine%20Learning%20(ML)%20workflows,training%20and%2020%25%20for%20testing">article</a> to get you started.</p>
<p>First, we want to set the seed. The seed is a number that is used to initialize the random number generator. This ensures that the random numbers generated by the model (i.e.&nbsp;the training and validation sets chosen by the computer) will be the same each time the code is run. This is important for reproducibility, as it allows us to get the same results each time we run the code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we use 80% of the training data for training and 20% for validation. We use a special function called <code>group_initial_split</code> to ensure that the training and validation sets are chosen by treating data from a given <code>subject_id</code> as a group (it cannot be split into smaller parts by, say, <code>actual_day_relative_to_boost</code>). This is important, since we want to ensure that all the data for a given subject_id is either in the training set or the testing set, but not both. Otherwise, we will have data that is split up, called data leakage, which can lead to poor model performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>training_split <span class="ot">&lt;-</span> <span class="fu">group_initial_split</span>(training, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">group =</span> <span class="st">"subject_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can extract the training and testing sets from the split:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>training_train <span class="ot">&lt;-</span> training_split <span class="sc">%&gt;%</span> <span class="fu">training</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>training_validation <span class="ot">&lt;-</span> training_split <span class="sc">%&gt;%</span> <span class="fu">testing</span>()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We can inspect the training and testing sets to see what they look like</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>training_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 182 × 20
   specimen_id isotype is_antigen_specific antigen   MFI MFI_normalised unit 
         &lt;dbl&gt; &lt;chr&gt;   &lt;lgl&gt;               &lt;chr&gt;   &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;
 1         468 IgG     FALSE               PT       113.          1     MFI  
 2         469 IgG     FALSE               PT       111.          0.987 MFI  
 3         470 IgG     FALSE               PT       126.          1.11  MFI  
 4         471 IgG     FALSE               PT       224.          1.99  MFI  
 5         472 IgG     FALSE               PT       304           2.70  MFI  
 6         473 IgG     FALSE               PT       274           2.43  MFI  
 7         474 IgG     FALSE               PT       172.          1.52  MFI  
 8         483 IgG     FALSE               PT       279.          2.47  MFI  
 9         484 IgG     FALSE               PT       441.          3.92  MFI  
10         485 IgG     FALSE               PT       498.          4.42  MFI  
# ℹ 172 more rows
# ℹ 13 more variables: lower_limit_of_detection &lt;dbl&gt;, subject_id &lt;dbl&gt;,
#   infancy_vac &lt;chr&gt;, biological_sex &lt;chr&gt;, ethnicity &lt;chr&gt;, race &lt;chr&gt;,
#   year_of_birth &lt;date&gt;, date_of_boost &lt;date&gt;, dataset &lt;chr&gt;,
#   actual_day_relative_to_boost &lt;dbl&gt;, planned_day_relative_to_boost &lt;dbl&gt;,
#   specimen_type &lt;chr&gt;, visit &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>training_validation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 49 × 20
   specimen_id isotype is_antigen_specific antigen   MFI MFI_normalised unit 
         &lt;dbl&gt; &lt;chr&gt;   &lt;lgl&gt;               &lt;chr&gt;   &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;
 1         475 IgG     FALSE               PT       125.           1.11 MFI  
 2         476 IgG     FALSE               PT       275.           2.44 MFI  
 3         477 IgG     FALSE               PT       263.           2.33 MFI  
 4         478 IgG     FALSE               PT       852.           7.56 MFI  
 5         479 IgG     FALSE               PT      1548.          13.7  MFI  
 6         480 IgG     FALSE               PT      1194.          10.6  MFI  
 7         481 IgG     FALSE               PT       680.           6.03 MFI  
 8         506 IgG     FALSE               PT       170.           1.51 MFI  
 9         507 IgG     FALSE               PT       148.           1.31 MFI  
10         508 IgG     FALSE               PT       150.           1.33 MFI  
# ℹ 39 more rows
# ℹ 13 more variables: lower_limit_of_detection &lt;dbl&gt;, subject_id &lt;dbl&gt;,
#   infancy_vac &lt;chr&gt;, biological_sex &lt;chr&gt;, ethnicity &lt;chr&gt;, race &lt;chr&gt;,
#   year_of_birth &lt;date&gt;, date_of_boost &lt;date&gt;, dataset &lt;chr&gt;,
#   actual_day_relative_to_boost &lt;dbl&gt;, planned_day_relative_to_boost &lt;dbl&gt;,
#   specimen_type &lt;chr&gt;, visit &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Now that we have our training and validation sets, we can begin setting up the model. We will use a basic linear regression model (least squares regression) to predict the antibody titers in the prediction dataset.</p>
<p>The following utilizes the <code>tidymodels</code> framework to specify the model.</p>
<p>The tidymodels framework is a collection of packages for modeling and machine learning using tidyverse principles. More information on this framework can be found in the following link: https://www.tidymodels.org/start/models/.</p>
</section>
<section id="preparing-baseline-value-dataframes" class="level2">
<h2 class="anchored" data-anchor-id="preparing-baseline-value-dataframes">Preparing Baseline Value Dataframes</h2>
<p>Our ultimate goal is to have a model that predicts antibody titer as a function of <code>actual_day_relative_to_boost</code>, <code>infancy_vac</code>, and <code>MFI_normalised_baseline</code>. The reason why we want <code>MFI_normalised_baseline</code> is because we want to account for the baseline antibody titer values for each subject. In other words, any given <code>subject_id</code> will have a different baseline antibody titer value, and if we also know their <code>infancy_vac</code> status, we can use this information to predict their antibody titer at day 14.</p>
<p><code>subject_id</code> is therefore not a predictor in the model, but rather a grouping variable.</p>
<p>To get <code>MFI_normalised_baseline</code>, we need to add a new column (variable) to our training and validation datasets that contains the baseline antibody titer value for each subject. We can then use this new column as a predictor in our model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe by filtering the baseline MFI_normalised values for each subject</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>baseline_values <span class="ot">&lt;-</span> training_train <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe that only has baseline values excluded for each subject</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>non_baseline_values <span class="ot">&lt;-</span> training_train <span class="sc">%&gt;%</span> </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Append baseline_values to non_baseline_values as a separate column and call it MFI_normalised_baseline. </span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>training_df <span class="ot">&lt;-</span> non_baseline_values <span class="sc">%&gt;%</span> </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(baseline_values[,<span class="fu">c</span>(<span class="st">'subject_id'</span>, <span class="st">'MFI_normalised'</span>)], <span class="at">by =</span> <span class="st">"subject_id"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_baseline"</span>))</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the same for training_test</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>baseline_values <span class="ot">&lt;-</span> training_validation <span class="sc">%&gt;%</span> </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>non_baseline_values <span class="ot">&lt;-</span> training_validation <span class="sc">%&gt;%</span> </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>validation_df <span class="ot">&lt;-</span> non_baseline_values <span class="sc">%&gt;%</span> </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(baseline_values[,<span class="fu">c</span>(<span class="st">'subject_id'</span>, <span class="st">'MFI_normalised'</span>)], <span class="at">by =</span> <span class="st">"subject_id"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_baseline"</span>))</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's also make infancy_vac column as factors, since we will be using them as factors in the model</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>training_validation<span class="sc">$</span>infancy_vac <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(training_validation<span class="sc">$</span>infancy_vac)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Since our end goal is to predict day 14 antibody titers, let's also remove any data in our training and validation sets where actual_day_relative_to_boost is greater than 14</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>training_df <span class="ot">&lt;-</span> training_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(actual_day_relative_to_boost <span class="sc">&lt;=</span> <span class="dv">14</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>validation_df <span class="ot">&lt;-</span> validation_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(actual_day_relative_to_boost <span class="sc">&lt;=</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setting-up-the-model" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-model">Setting Up the Model</h2>
<p>In the tidymodels framework, we can specify our linear model using the <code>lm()</code> function. We then use the <code>set.engine()</code> function to specify that we want to use the <code>lm()</code> function to fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specifying the model using the tidymodels framework</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>) <span class="co"># using the default lm engine (ordinary least squares regression) </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>lm_train <span class="ot">&lt;-</span> lm_spec <span class="sc">%&gt;%</span> <span class="co"># establishing the model to fit the training data with</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(MFI_normalised <span class="sc">~</span> actual_day_relative_to_boost <span class="sc">+</span> MFI_normalised_baseline <span class="sc">+</span> infancy_vac, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> training_df) <span class="co"># specifying the predictors and the response variable that the model will use to fit the training data</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply lm_train to the validation data</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>ab_validation <span class="ot">&lt;-</span> validation_df <span class="sc">%&gt;%</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">predict</span>(lm_train, validation_df)) <span class="co"># adding a new column to the validation dataframe that contains the predicted antibody titers</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong><em>IMPORTANT!</em></strong>: The advantage of using the tidymodels framework is that if we wanted to change the model to a different type of model, all we need to do is change the <code>linear_reg()</code> function to another function, such as Lasso regression, by changing only the arguments and <code>set_engine()</code> function as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specifying the model using the tidymodels framework</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   lm_spec &lt;- </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     linear_reg(penalty = 0, mixture = 1) %&gt;% # specifies the penalty and mixture for lasso regression</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     set_engine("glmnet") # specifies the engine used for lasso</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting the model to the training data</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   lm_train &lt;- lm_spec %&gt;% </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     fit(MFI_normalised ~ actual_day_relative_to_boost + MFI_normalised_baseline +                  infancy_vac, data = training_df)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply lm_train to the validation data and score for accuracy</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   ab_validation &lt;- validation_df %&gt;%</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     mutate(predict(lm_train, validation_df))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Feel free to play around with different models and see how they perform. You may consult the <a href="https://parsnip.tidymodels.org/articles/Examples.html#linear_reg-models">documentation</a> for the <code>tidymodels</code> framework for more information on different models and how to specify them.</p>
<p>Ultimately, using tidymodels allows us to easily switch between different models, which would otherwise be more cumbersome to do using the base R functions.</p>
<section id="evaluating-the-model" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-the-model">Evaluating the Model</h3>
<p>Let’s plot out the data to see how well our model is doing. Each graph represents a different subject, and the black line represents the predicted antibody titers. The colored points represent the actual antibody titers, and the color of the points represents whether the subject received the infancy vaccine or not.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate Model Using ggplot</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ab_validation, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> actual_day_relative_to_boost, <span class="at">y =</span> MFI_normalised,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> infancy_vac)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .pred), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>subject_id) <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CMI-PB_Prediction_Walkthrough_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It appears our model is doing a decent job of predicting the antibody titers from d0 to d14. We can also evaluate the model more quantitatively using the Spearman correlation between predicted and actual antibody titers columns in our ab_validation dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the Spearman correlation</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(ab_validation<span class="sc">$</span>MFI_normalised, ab_validation<span class="sc">$</span>.pred, <span class="at">method =</span> <span class="st">"spearman"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  ab_validation$MFI_normalised and ab_validation$.pred
S = 584, p-value = 1.348e-06
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.8401752 </code></pre>
</div>
</div>
<p><strong><em>IMPORTANT</em></strong>: depending on how you modify the model specifications, predictor variables, etc, you might get different Spearman correlation values. In making such specifications, you must consider overfitting/underfitting, a concept in machine learning that is very important to consider. Here is a <a href="https://medium.com/mlearning-ai/overfitting-vs-underfitting-6a41b3c6a9ad">resource</a> to get you started on these concepts.</p>
<p>As given by the relatively high Spearman correlation, the model is doing a good job of predicting the antibody titers.</p>
<p>Now that we have evaluated that our model is doing a good job of predicting antibody titers at d14, let’s now predict the antibody titers in the 2022 prediction dataset using the model we just fit to the training data.</p>
</section>
</section>
<section id="predicting-antibody-titers-in-the-validation-dataset" class="level2">
<h2 class="anchored" data-anchor-id="predicting-antibody-titers-in-the-validation-dataset">Predicting Antibody Titers in the Validation Dataset</h2>
<p>We need to first repeat the preprocessing steps we did for the training and validation datasets for the prediction dataset. This includes adding a new column for the baseline antibody titer values for each subject, and then using the model to predict the antibody titers at d14.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe that only has the baseline values for each subject</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>baseline_values_predict <span class="ot">&lt;-</span> prediction <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename baseline values to 'MFI_normalised_baseline'</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>baseline_values_predict <span class="ot">&lt;-</span> baseline_values_predict <span class="sc">%&gt;%</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">MFI_normalised_baseline =</span> MFI_normalised)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we will use a function called <code>expand.grid()</code> to create a dataframe that specifies the d14 antibody titer predictions for each subject. We will then apply the model to this expanded dataframe to predict the antibody titers at d14 for each subject in the prediction dataset. Remember, this new dataframe must have all the predictor variables that the model was trained on!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand grid to create d14 output for each subject</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>new_points <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">actual_day_relative_to_boost =</span> <span class="dv">14</span>, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">subject_id =</span> <span class="fu">unique</span>(baseline_values_predict<span class="sc">$</span>subject_id))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Append MFI_normalised_baseline and infancy_vac values from baseline_values_predict as separate columns to create the final dataframe. We are joining by matching subject_id.</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>new_points <span class="ot">&lt;-</span> new_points <span class="sc">%&gt;%</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(baseline_values_predict[,<span class="fu">c</span>(<span class="st">'subject_id'</span>, <span class="st">'MFI_normalised_baseline'</span>, <span class="st">'infancy_vac'</span>)], <span class="at">by =</span> <span class="st">"subject_id"</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># We now have a dataframe that contains all the information needed for the model to predict the antibody titers at d14 for each subject in the prediction dataset.</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the model to the prediction dataset</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>ab_prediction <span class="ot">&lt;-</span> new_points <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted =</span> <span class="fu">predict</span>(lm_train, <span class="at">new_data =</span> new_points)) <span class="sc">%&gt;%</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(predicted)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's inspect ab_prediction to see the predicted antibody titers at d14 for each subject_id</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ab_prediction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  actual_day_relative_to_b…¹ subject_id MFI_normalised_basel…² infancy_vac .pred
                       &lt;dbl&gt;      &lt;dbl&gt;                  &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
1                         14        114                  0.358 wP           6.32
2                         14        103                  0.704 wP           6.64
3                         14        117                  1.04  aP           5.07
4                         14         98                  1.31  wP           7.20
5                         14        116                  1.68  aP           5.66
6                         14        105                  0.905 wP           6.82
# ℹ abbreviated names: ¹​actual_day_relative_to_boost, ²​MFI_normalised_baseline</code></pre>
</div>
</div>
</section>
<section id="importing-actual-d14-antibody-titers-to-compare" class="level2">
<h2 class="anchored" data-anchor-id="importing-actual-d14-antibody-titers-to-compare">Importing Actual d14 Antibody Titers to Compare</h2>
<p>While we have been working with a 2022 dataset (prediction dataset) that only has d0 baseline values, we have access to the actual d14 antibody titers from the 2022 dataset. We can use these to compare our predicted values to the actual values.</p>
<p>The entire 2020, 2021, 2022 antibody titer combined dataset is available from the CMI-PB application programming interface (API). We can use the <code>jsonlite</code> package to import the data, which is in JSON format.</p>
<p>API is an interface that essentially has a set of functions and procedures that allow programs to access data and features from another application. In this case, this would be our computer to CMI-PB data. The API outlines available options (different types of datasets). As a developer, you can make requests to these API endpoints to use them in your own application.</p>
<p>We essentially want to repeat all of the above steps for this new data (except training split). This will allow us to ultimately visualize the predicted vs.&nbsp;actual d0 - d14 antibody titers for each subject in the 2022 dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the data</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'jsonlite'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    flatten</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>actual_data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="st">"https://www.cmi-pb.org/api/v4_1/plasma_ab_titer"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Pre-Processing</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Sort the data for 2022 specimens using prediction_specimen metadata</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>actual_data_2022 <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(actual_data, prediction_meta, <span class="at">by =</span> <span class="st">"specimen_id"</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Filter for d0 to d14 values for IgG against PT only</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>actual_data_2022 <span class="ot">&lt;-</span> actual_data_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span> <span class="sc">:</span> <span class="dv">14</span>), antigen <span class="sc">==</span> <span class="st">"PT"</span>, isotype <span class="sc">==</span> <span class="st">"IgG"</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparing Baseline Value Dataframes</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Create a dataframe by filtering the baseline MFI_normalised values for each subject</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>baseline_2022 <span class="ot">&lt;-</span> actual_data_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Create a dataframe that only has baseline values excluded for each subject</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>non_baseline_2022 <span class="ot">&lt;-</span> actual_data_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(planned_day_relative_to_boost <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Append baseline values to non-baseline values as a separate column and call it MFI_normalised_baseline. </span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>df_2022 <span class="ot">&lt;-</span> non_baseline_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(baseline_2022[,<span class="fu">c</span>(<span class="st">'subject_id'</span>, <span class="st">'MFI_normalised'</span>)], <span class="at">by =</span> <span class="st">"subject_id"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_baseline"</span>))</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying the Model to the 2022 Dataset</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>ab_2022 <span class="ot">&lt;-</span> df_2022 <span class="sc">%&gt;%</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">predict</span>(lm_train, df_2022)) </span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="do">## Plotting the Predicted and Actual 2022 Data</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ab_2022, </span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> actual_day_relative_to_boost, <span class="at">y =</span> MFI_normalised,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> infancy_vac)) <span class="sc">+</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .pred), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>subject_id) <span class="sc">+</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CMI-PB_Prediction_Walkthrough_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate the Spearman correlation</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(ab_2022<span class="sc">$</span>MFI_normalised, ab_2022<span class="sc">$</span>.pred, <span class="at">method =</span> <span class="st">"spearman"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  ab_2022$MFI_normalised and ab_2022$.pred
S = 61638, p-value = 0.0004651
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.3759441 </code></pre>
</div>
</div>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>As you can see with our plotted predicted vs.&nbsp;actual 2022 data, and the Spearman Correlation, the model that was trained on 2021 data does very poorly on the 2022 data. This represents the goal of systems vaccinology - to understand how to better predict the immune response to a vaccine in a new population. The very basic model we used in this tutorial is not sufficient to predict the immune response to the vaccine, and highlights how there is much to learn about how to predict the immune response to vaccines in different populations. Understanding this will ultimately allow better vaccine design, and therefore more robust individual and population immunity against preventable diseases.</p>
<section id="possible-extensions" class="level3">
<h3 class="anchored" data-anchor-id="possible-extensions">Possible Extensions</h3>
<p>As mentioned previously, the tidymodels framework allows you to change the model type easily. This is useful if you want to compare different models to see which one performs best. Feel free to try different models and compare their performance qualitatively by plotting the predicted values against the actual values for each subject in the validation dataset, and quantitatively using Spearman correlation. You may also try other methods of evaluating the model, such as mean squared error or root mean squared error.</p>
<p>You may also choose to change the predictor variables in the model to see if you can improve the model’s performance. For example, you may want to include other variables such as age, sex, race, etc. to see if they improve the model’s performance.</p>
<p>To extend your learning, you may choose to look at other datasets in the CMI-PB challenge to see if you can model other types of data, such as PBMC cell frequency. These other datasets may be found <a href="https://www.cmi-pb.org/blog/prediction-challenge-overview/#Data%20and%20resources">here</a>.</p>
<p>We hope that this tutorial has given you a good introduction to the tidymodels framework and how to use it to fit a basic machine learning model to predict antibody titers. For additional information/resources, please refer to the <a href="https://www.tidymodels.org/">tidymodels website</a>. Some other useful things to learn to deepen you knowledge include: Lasso regression, Ridge regression, Elastic net regression, and any other type of modeling method you are interested in.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>